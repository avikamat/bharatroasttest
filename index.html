<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Bharat Roast — Super MVP</title>
<meta name="description" content="Bharat Roast — prototype social app (local-only) with posts, stories, explore, DMs, and more."/>
<link rel="manifest" href="site.webmanifest">
<style>
  /* ---------------------------
     Base theme & utilities
     --------------------------- */
  :root{
    --bg:#0b0b0c; --card:#121214; --muted:#9aa0a6; --accent:#ff3b30; --accent-2:#1f8fff;
    --glass: rgba(255,255,255,0.03);
    --glass-2: rgba(255,255,255,0.02);
    --success:#08a045;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    --radius:12px;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#070708 0%, #0b0b0c 100%);color:#e8eef6}
  *{box-sizing:border-box}
  img{max-width:100%;display:block}
  .app{max-width:1080px;margin:0 auto;padding:18px;min-height:100vh;display:grid;grid-template-columns:1fr 360px;gap:18px}
  @media(max-width:980px){ .app{grid-template-columns:1fr} .rightcol{order:2} }

  /* Topbar */
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--card);border-radius:var(--radius);margin-bottom:4px;box-shadow:0 6px 24px rgba(0,0,0,0.45)}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#ff7a6b);display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;letter-spacing:0.6px}
  .title{font-size:18px;font-weight:700}
  .subtitle{font-size:12px;color:var(--muted)}
  .row{display:flex;gap:8px;align-items:center}

  /* Cards & layout */
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:12px;border-radius:var(--radius); margin-bottom:14px; box-shadow:0 6px 18px rgba(0,0,0,0.6)}
  .small{font-size:12px;color:var(--muted)}
  .btn{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:#fff;cursor:pointer;font-weight:600}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer}

  /* Composer */
  .composer{display:flex;gap:12px;align-items:flex-start}
  .composer textarea{width:100%;min-height:80px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;resize:vertical}
  .composer .compose-actions{display:flex;flex-direction:column;gap:8px;min-width:160px}

  /* Feed */
  .feed{display:flex;flex-direction:column;gap:12px}
  .post{padding:12px;border-radius:10px;background:linear-gradient(180deg,#0f0f10, rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02)}
  .meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .author{font-weight:700}
  .time{font-size:12px;color:var(--muted)}
  .content{white-space:pre-wrap;margin:8px 0}
  .actions{display:flex;gap:8px;align-items:center;margin-top:8px}
  .icon-btn{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;color:var(--muted);cursor:pointer}
  .icon-btn.active{border-color:var(--accent);color:var(--accent)}
  .badge{background:rgba(255,255,255,0.04);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}

  /* Right column specifics */
  .rightcol .card{position:sticky;top:18px}
  .template{padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer;border:1px dashed rgba(255,255,255,0.03);font-size:14px}
  .leaderboard-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.02)}

  /* Floating */
  .post-floating{position:fixed;right:18px;bottom:18px;background:var(--accent);border:none;padding:14px;border-radius:50%;font-weight:800;color:#fff;box-shadow:0 10px 30px rgba(0,0,0,0.6);cursor:pointer}

  /* Notifications */
  .notif{position:fixed;left:50%;transform:translateX(-50%);top:18px;background:#08a045;padding:10px 16px;border-radius:10px;color:#fff;display:none}
  .danger{background:#b01c1c}

  /* Tags */
  .tag{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:13px;color:var(--muted);margin-right:6px;cursor:pointer}

  /* Stories */
  .stories{display:flex;gap:8px;overflow:auto;padding:6px 0}
  .story{min-width:76px;height:100px;border-radius:12px;background:linear-gradient(180deg,#161616,#121212);display:flex;align-items:flex-end;padding:8px;color:#fff;cursor:pointer;border:2px solid rgba(255,255,255,0.02)}
  .story .s-name{font-size:12px;color:var(--muted);font-weight:700}

  /* Explore grid */
  .explore-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));grid-gap:8px}
  .explore-item{border-radius:10px;overflow:hidden;background:linear-gradient(180deg,#111,#0b0b0c);height:140px;display:flex;align-items:center;justify-content:center;color:var(--muted);font-weight:700}

  /* Modal/drawer */
  .drawer{position:fixed;right:-360px;top:0;height:100%;width:360px;background:#111;border-left:1px solid #333;padding:14px;transition:0.28s;overflow-y:auto;z-index:999}
  .drawer.open{right:0}
  .modal-overlay{display:none;position:fixed;top:0;left:0;height:100%;width:100%;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);align-items:center;justify-content:center;z-index:9999}
  .modal-overlay.show{display:flex}
  .modal{background:#121214;padding:18px;border-radius:12px;width:94%;max-width:520px}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}

  /* tiny UX */
  .skeleton{background:linear-gradient(90deg,#121214,#0f0f10);height:14px;border-radius:6px;opacity:0.6}
  .muted{color:var(--muted)}
  footer{opacity:0.6;text-align:center;margin-top:30px;font-size:13px;color:var(--muted)}
  .u-xxs{font-size:11px;color:var(--muted)}
  .avatar{width:42px;height:42px;border-radius:10px;background:rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;font-weight:700}
  input[type=file]{display:none}
  .media-preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .media-thumb{width:100px;height:80px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
  .level{font-weight:800;color:var(--accent-2)}
</style>
</head>
<body>
<div class="notif" id="notif"></div>

<!-- App shell -->
<div class="topbar card">
  <div class="brand">
    <div class="logo">BR</div>
    <div>
      <div class="title">Bharat Roast</div>
      <div class="subtitle">India's truth & roast feed</div>
    </div>
  </div>

  <div class="row">
    <button id="openExplore" class="ghost">Explore</button>
    <button id="openNotif" class="ghost">🔔 <span id="notifCount" style="margin-left:6px"></span></button>
    <div id="user-area"></div>
  </div>
</div>

<div class="app" id="app">

  <!-- Main column -->
  <div>
    <!-- Composer -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Create Post</strong><div class="small">Share a truth, roast or image — keep it kind of spicy</div></div>
        <div class="small">Character safe: 1200</div>
      </div>
      <div style="height:12px"></div>
      <div class="composer">
        <div style="flex:1">
          <textarea id="postContent" placeholder="Write a roast or truth..."></textarea>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <label style="display:flex;gap:8px;align-items:center"><input id="postAnon" type="checkbox" checked /> <span class="small">Post anonymously</span></label>
            <select id="postTone" class="badge">
              <option value="witty">Witty</option>
              <option value="savage">Savage</option>
              <option value="chill">Chill</option>
              <option value="flirty">Flirty</option>
              <option value="royal">Royal</option>
            </select>

            <div style="flex:1"></div>

            <label for="mediaUpload" class="ghost" style="cursor:pointer">📷 Add Media</label>
            <input id="mediaUpload" type="file" accept="image/*" multiple>
          </div>
          <div class="media-preview" id="mediaPreview"></div>
        </div>

        <div class="compose-actions">
          <button class="btn" id="postBtn">Post</button>
          <button class="ghost" id="aiRoastBtn">🤖 AI Roast</button>
          <button class="ghost" id="clearComposer">Clear</button>
          <div class="small muted">Ctrl+Enter to post</div>
        </div>
      </div>
    </div>

    <!-- Stories -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Stories</strong><div class="small">Short roasts & moments</div></div>
        <button id="newStory" class="ghost">+ Add</button>
      </div>
      <div class="stories" id="storiesRow" aria-label="Stories list"></div>
    </div>

    <!-- Feed filters -->
    <div style="display:flex;gap:8px;margin:12px 0 6px 0">
      <input id="searchInput" class="search" placeholder="Search feed text, tags or author..." style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit" />
      <select id="sortSelect" class="ghost" title="Sort">
        <option value="new">Newest</option>
        <option value="top">Top (likes)</option>
      </select>
      <select id="topicSelect" class="ghost">
        <option value="">All Topics</option>
        <option>Parents</option><option>SchoolLife</option><option>KotaTruths</option><option>Dating</option><option>Bollywood</option>
      </select>
    </div>

    <!-- Feed -->
    <div id="feed" class="feed"></div>

    <button class="post-floating" id="floatingPost">+</button>

    <!-- Load more skeleton area -->
    <div id="loadingMore" style="display:none;margin-top:12px">
      <div class="card"><div class="skeleton" style="width:60%"></div><div style="height:10px"></div><div class="skeleton" style="width:80%"></div></div>
    </div>

  </div>

  <!-- Right column -->
  <div class="rightcol">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div><strong>Trending Tags</strong><div class="small">What's being roasted</div></div>
        <button id="clearBtn" class="ghost">Clear</button>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:8px" id="trendingTags">
        <div class="tag" data-tag="Parents">#Parents</div>
        <div class="tag" data-tag="SchoolLife">#SchoolLife</div>
        <div class="tag" data-tag="KotaTruths">#KotaTruths</div>
        <div class="tag" data-tag="Dating">#Dating</div>
        <div class="tag" data-tag="Bollywood">#Bollywood</div>
      </div>
    </div>

    <div class="card">
      <strong>Post Templates</strong>
      <div class="small" style="margin-top:6px">Tap to use — ready-made viral formats</div>
      <div style="margin-top:10px;display:grid;grid-template-columns:1fr;gap:8px">
        <div class="template" data-t="Parents be like: 'Beta, phone mat chalao'... *but 2 AM Reels*">Parents truth format</div>
        <div class="template" data-t="School taught us X but not Y — why?">School reality format</div>
        <div class="template" data-t="Unpopular opinion: Coaching culture is...">Unpopular opinion format</div>
        <div class="template" data-t="If my parents saw my bank balance they'd...">Money truth format</div>
      </div>
    </div>

    <div class="card">
      <strong>Leaderboard</strong>
      <div class="small" style="margin-top:6px">Top witty users (by likes)</div>
      <div id="leaderboardList" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <strong>Quick Actions</strong>
      <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
        <button class="ghost" id="demoFill">Load Demo Posts</button>
        <button class="ghost" id="exportBtn">Export Data (JSON)</button>
        <button class="ghost danger" id="wipeBtn" style="background:#2b1b1b;color:#ffb3b3">Wipe Local Data</button>
        <button class="ghost" id="openDMs">Open DMs</button>
        <button class="ghost" id="toggleTheme">Toggle Theme</button>
      </div>
    </div>

  </div>
</div>

<footer>Built for rapid MVP testing — local only. Later: Firebase backend, AI meme generator, monetization.</footer>

<!-- DRAWERS & MODALS -->
<div id="notifDrawer" class="drawer" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <strong>🔔 Notifications</strong>
    <button class="ghost" id="closeNotifDrawer">Close</button>
  </div>
  <div id="notifHistory"></div>
</div>

<div id="profileModal" class="modal-overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-header">
      <strong id="profileName">Profile</strong>
      <button class="ghost" id="closeProfileModal">✖</button>
    </div>
    <div class="small" id="profileUserMeta"></div>
    <div id="profilePosts" style="margin-top:12px"></div>
  </div>
</div>

<div id="storyModal" class="modal-overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-header">
      <strong id="storyTitle">Story</strong>
      <button class="ghost" id="closeStoryModal">✖</button>
    </div>
    <div id="storyContent"></div>
  </div>
</div>

<div id="dmModal" class="modal-overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-header">
      <strong>Direct Messages</strong>
      <button class="ghost" id="closeDMs">Close</button>
    </div>
    <div style="display:flex;gap:8px">
      <div style="width:33%;border-right:1px solid rgba(255,255,255,0.02);padding-right:8px">
        <div id="dmList"></div>
      </div>
      <div style="flex:1">
        <div id="dmThread"></div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <input id="dmInput" placeholder="Write message..." style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit" />
          <button id="dmSend" class="btn">Send</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="reportModal" class="modal-overlay" aria-hidden="true">
  <div class="modal">
    <div class="modal-header">
      <strong>Report Post</strong>
      <button class="ghost" id="closeReportModal">✖</button>
    </div>
    <div class="small">Why are you reporting?</div>
    <select id="reportReason" class="search" style="margin-top:10px;width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit">
      <option>Harassment</option>
      <option>Hate Speech</option>
      <option>Misleading Info</option>
      <option>Spam / Promotion</option>
      <option>NSFW</option>
    </select>
    <button id="submitReport" class="btn" style="margin-top:10px;width:100%">Submit Report</button>
  </div>
</div>

<script>
/* ==================================================
   Bharat Roast — Expanded Single-file Frontend Prototype
   Features:
   - users, posts (text + images), stories, likes, comments, bookmarks
   - follows, profiles, DMs (mock), notifications, explore
   - localStorage persistence
   - basic PWA registration stub
   ================================================== */

/* -------------------------
   Storage key & initial state
   ------------------------- */
const DBKEY = 'bharat_roast_super_v2';
let state = {
  users: [],    // {id, username, displayName, score, bio, following:[], followers:[], badges:[], xp: number}
  posts: [],    // {id, authorId, authorName, content, media:[{id,src}], anonymous, likes:[], comments:[], flags:, createdAt, tone, tags:[]}
  stories: [],  // {id, authorId, title, createdAt, content}
  dms: [],      // {threadId, participants:[ids], messages: [{from,txt,at}]}
  notifications: [], // {id, userId, text, read, at}
  currentUserId: null,
  bookmarks: [], // array of postIds per current user persisted under user key
  reports: []
};

/* -------------------------
   Utilities
   ------------------------- */
function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,10); }
function nowISO(){ return new Date().toISOString(); }
function save(){ localStorage.setItem(DBKEY, JSON.stringify(state)); }
function load(){
  const raw = localStorage.getItem(DBKEY);
  if(raw){ try{ state = JSON.parse(raw); } catch(e){ console.error(e); localStorage.removeItem(DBKEY); } }
  state.users = state.users || [];
  state.posts = state.posts || [];
  state.stories = state.stories || [];
  state.dms = state.dms || [];
  state.notifications = state.notifications || [];
  state.currentUserId = state.currentUserId || null;
  state.bookmarks = state.bookmarks || [];
  state.reports = state.reports || [];
}
function notify(msg, danger=false){
  const n = document.getElementById('notif');
  n.innerText = msg; n.style.display='block';
  n.style.background = danger? '#b01c1c' : '#08a045';
  setTimeout(()=> n.style.display='none', 1800);
}
function timeAgo(iso){
  const d = new Date(iso); const diff = Date.now() - d.getTime();
  if(diff < 60000) return Math.round(diff/1000) + 's';
  if(diff < 3600000) return Math.round(diff/60000) + 'm';
  if(diff < 86400000) return Math.round(diff/3600000) + 'h';
  return d.toLocaleDateString();
}
function sanitize(s){ return (s||'').replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* -------------------------
   Seed data if empty
   ------------------------- */
function seedIfEmpty(){
  if(state.users.length===0){
    const a = {id:uid('u'), username:'roastlord', displayName:'RoastLord', score:12, bio:'King of roasts', following:[], followers:[], badges:['OG'], xp:120};
    const b = {id:uid('u'), username:'savage_sai', displayName:'SavageSai', score:9, bio:'Sarcastic but kind', following:[], followers:[], badges:[], xp:80};
    const c = {id:uid('u'), username:'anonfan', displayName:'AnonFan', score:3, bio:'lurking', following:[], followers:[], badges:[], xp:10};
    state.users.push(a,b,c);
  }
  if(state.posts.length===0){
    state.posts.push(
      {id:uid('p'), authorId:state.users[0].id, authorName:state.users[0].displayName, content:'Indian parents: "Beta phone mat chalao" — also watching reels at 2AM 😂', media:[], anonymous:false, likes:[state.users[1].id], comments:[{id:uid('c'), from:state.users[1].id, txt:'Facts!', at:nowISO()}], flags:0, createdAt:new Date(Date.now()-3600*1000*6).toISOString(), tone:'witty', tags:['Parents']},
      {id:uid('p'), authorId:null, authorName:'Anonymous', content:"School taught us Pythagoras but not how to handle relatives 😭", media:[], anonymous:true, likes:[], comments:[], flags:0, createdAt:new Date(Date.now()-3600*1000*2).toISOString(), tone:'savage', tags:['SchoolLife']},
      {id:uid('p'), authorId:state.users[1].id, authorName:state.users[1].displayName, content:"Unpopular opinion: Kota motivation is temporary consumerism of hope", media:[], anonymous:false, likes:[state.users[0].id], comments:[], flags:0, createdAt:new Date(Date.now()-3600*1000*1).toISOString(), tone:'chill', tags:['KotaTruths']}
    );
  }
  if(state.stories.length===0){
    state.stories.push({id:uid('s'), authorId:state.users[0].id, title:'Roast clip', createdAt:nowISO(), content:'Short roast story — 8s text'});
  }
  save();
}

/* -------------------------
   Render: user area
   ------------------------- */
function renderUserArea(){
  const ua = document.getElementById('user-area');
  ua.innerHTML = '';
  if(state.currentUserId){
    const u = state.users.find(x=>x.id===state.currentUserId);
    if(!u){ state.currentUserId = null; save(); renderUserArea(); return; }
    const el = document.createElement('div');
    el.innerHTML = `<div style="display:flex;align-items:center;gap:10px">
      <div class="avatar">${sanitize(u.displayName[0]||'U')}</div>
      <div style="text-align:right">
        <div style="font-weight:700">${sanitize(u.displayName)}</div>
        <div class="small">@${sanitize(u.username)} · <span class="level">${Math.floor(u.xp/50)||1}★</span></div>
      </div>
      <div style="width:10px"></div>
      <button class="ghost" id="logoutBtn">Logout</button>
    </div>`;
    ua.appendChild(el);
    document.getElementById('logoutBtn').onclick = ()=>{ state.currentUserId = null; save(); renderAll(); notify('Logged out') };
  } else {
    const el = document.createElement('div');
    el.innerHTML = `<div style="display:flex;gap:8px">
      <button class="ghost" id="quickReg">Quick Join</button>
      <button class="ghost" id="openLogin">Login</button>
    </div>`;
    ua.appendChild(el);
    document.getElementById('quickReg').onclick = quickRegister;
    document.getElementById('openLogin').onclick = showLoginPrompt;
  }
}

/* -------------------------
   Composer handlers
   ------------------------- */
let stagedMedia = []; // {id,src}
document.getElementById('mediaUpload').addEventListener('change', (e)=>{
  const files = Array.from(e.target.files || []);
  files.forEach(f=>{
    const reader = new FileReader();
    reader.onload = ()=> {
      const id = uid('m');
      stagedMedia.push({id, src: reader.result});
      renderMediaPreview();
    };
    reader.readAsDataURL(f);
  });
  e.target.value = '';
});
function renderMediaPreview(){
  const root = document.getElementById('mediaPreview');
  root.innerHTML = '';
  stagedMedia.forEach(m=>{
    const img = document.createElement('img');
    img.className = 'media-thumb';
    img.src = m.src;
    img.title = 'Click to remove';
    img.onclick = ()=> { stagedMedia = stagedMedia.filter(x=>x.id!==m.id); renderMediaPreview(); };
    root.appendChild(img);
  });
}
document.getElementById('clearComposer').onclick = ()=> { document.getElementById('postContent').value=''; stagedMedia=[]; renderMediaPreview(); notify('Composer cleared') };
document.getElementById('aiRoastBtn').onclick = ()=> {
  const r = generateAiRoast();
  document.getElementById('postContent').value = r;
  notify('AI Roast Generated');
};

/* quick register/login */
function quickRegister(){
  const uname = 'user' + Math.floor(Math.random()*9000+1000);
  const user = { id: uid('u'), username: uname, displayName: uname, score: 0, bio:'', following:[], followers:[], badges:[], xp:0 };
  state.users.push(user);
  state.currentUserId = user.id;
  save(); renderAll();
  notify('Quick account created: @' + uname);
}
function showLoginPrompt(){
  const uname = prompt('Enter username (registered):');
  if(!uname) return;
  const user = state.users.find(u=>u.username === uname);
  if(!user){ if(confirm('User not found. Create new user with this username?')) {
      const newu = {id:uid('u'), username: uname, displayName: uname, score: 0, bio:'', following:[], followers:[], badges:[], xp:0};
      state.users.push(newu); state.currentUserId = newu.id; save(); renderAll(); notify('Account created'); return;
    } else { return; }
  }
  state.currentUserId = user.id; save(); renderAll(); notify('Logged in as @' + user.username);
}

/* Post creation */
document.getElementById('postBtn').onclick = handlePost;
document.getElementById('postContent').addEventListener('keydown', (e)=> { if(e.ctrlKey && e.key==='Enter') handlePost(); });
function handlePost(){
  const content = document.getElementById('postContent').value.trim();
  if(!content && stagedMedia.length===0) return notify('Type something or add media', true);
  const anon = document.getElementById('postAnon').checked;
  const tone = document.getElementById('postTone').value;
  if(!state.currentUserId && !confirm('You are not logged in. Post will be anonymous. Continue?')) return;
  const author = state.users.find(u=>u.id===state.currentUserId);
  const post = {
    id: uid('p'),
    authorId: anon ? null : (author? author.id : null),
    authorName: anon ? 'Anonymous' : (author? author.displayName : 'Anonymous'),
    content,
    media: stagedMedia.map(m=>({id:m.id, src:m.src})),
    anonymous: !!anon,
    likes: [],
    comments: [],
    flags: 0,
    createdAt: nowISO(),
    tone,
    tags: extractTags(content)
  };
  state.posts.unshift(post);
  stagedMedia = []; renderMediaPreview();
  // award xp
  if(author){ author.xp = (author.xp||0) + 5; }
  save();
  document.getElementById('postContent').value = '';
  notify('Posted');
  renderAll();
}

/* Tags extract: simple # or keywords mapping */
function extractTags(text){
  const tagset = [];
  const rx = /#([A-Za-z0-9_]+)/g;
  let m;
  while((m = rx.exec(text)) !== null){ tagset.push(m[1]); }
  // also simple heuristics
  if(/parents/i.test(text) && !tagset.includes('Parents')) tagset.push('Parents');
  return tagset;
}

/* -------------------------
   Rendering feed & actions
   ------------------------- */
function renderFeed(){
  const feed = document.getElementById('feed');
  feed.innerHTML = '';
  const q = (document.getElementById('searchInput').value || '').toLowerCase();
  const sort = document.getElementById('sortSelect').value;
  const topic = (document.getElementById('topicSelect').value || '').toLowerCase();

  let posts = state.posts.slice();

  if(q) posts = posts.filter(p => (p.content||'').toLowerCase().includes(q) || (p.authorName||'').toLowerCase().includes(q) || (p.tags||[]).join(' ').toLowerCase().includes(q));
  if(topic) posts = posts.filter(p => (p.tags||[]).map(t=>t.toLowerCase()).includes(topic));
  if(sort==='top') posts.sort((a,b)=> (b.likes||[]).length - (a.likes||[]).length || new Date(b.createdAt)-new Date(a.createdAt));
  else posts.sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt));

  posts.forEach(p=>{
    const el = document.createElement('div');
    el.className = 'post card';
    const likeCount = (p.likes||[]).length;
    const authorDisplay = p.authorName || 'Anonymous';
    const tone = p.tone || 'witty';
    // media section
    const mediaHtml = p.media && p.media.length ? `<div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">${p.media.map(m=>`<img src="${m.src}" style="width:180px;height:130px;object-fit:cover;border-radius:8px">`).join('')}</div>` : '';
    el.innerHTML = `
      <div class="meta">
        <div style="display:flex;gap:10px;align-items:center">
          <div class="avatar" style="width:44px;height:44px;cursor:pointer" data-user="${p.authorId || ''}">${sanitize((p.authorName||'A')[0])}</div>
          <div>
            <div class="author" style="cursor:pointer" data-user="${p.authorId || ''}">${sanitize(authorDisplay)}</div>
            <div class="small">${timeAgo(p.createdAt)} · ${sanitize(tone)}</div>
          </div>
        </div>
        <div class="small">${likeCount} ❤</div>
      </div>
      <div class="content">${sanitize(p.content)}</div>
      ${mediaHtml}
      <div style="margin-top:8px">${(p.tags||[]).map(t=>`<span class="tag" data-tag="${t}">#${sanitize(t)}</span>`).join(' ')}</div>
      <div class="actions">
        <button class="icon-btn like-btn" data-id="${p.id}">${p.likes && p.likes.includes(state.currentUserId) ? '💖 Liked' : '♡ Like'}</button>
        <button class="icon-btn comment-btn" data-id="${p.id}">💬 Comment</button>
        <button class="icon-btn share-btn" data-id="${p.id}">⤴ Share</button>
        <button class="icon-btn bookmark-btn" data-id="${p.id}">${state.bookmarks && state.bookmarks.includes(p.id) ? '🔖 Bookmarked' : '🔖 Bookmark'}</button>
        <button class="icon-btn report-btn" data-id="${p.id}">⚑ Report</button>
      </div>
      <div class="small" style="margin-top:8px" id="comments-${p.id}">${(p.comments||[]).slice(0,3).map(c=>`<div><strong>${getUserDisplay(c.from)}</strong> · ${sanitize(c.txt)}</div>`).join('')}${(p.comments&&p.comments.length>3?`<div class="u-xxs muted">+${p.comments.length-3} more</div>`:'')}</div>
    `;
    feed.appendChild(el);
  });

  // Wire up buttons
  feed.querySelectorAll('.like-btn').forEach(b=> b.onclick = ()=> toggleLike(b.getAttribute('data-id')) );
  feed.querySelectorAll('.comment-btn').forEach(b=> b.onclick = ()=> openCommentPrompt(b.getAttribute('data-id')) );
  feed.querySelectorAll('.share-btn').forEach(b=> b.onclick = ()=> sharePost(b.getAttribute('data-id')) );
  feed.querySelectorAll('.bookmark-btn').forEach(b=> b.onclick = ()=> toggleBookmark(b.getAttribute('data-id')) );
  feed.querySelectorAll('.report-btn').forEach(b=> b.onclick = ()=> openReport(b.getAttribute('data-id')) );
  feed.querySelectorAll('[data-user]').forEach(el=> el.onclick = (e)=> {
    const id = el.getAttribute('data-user');
    if(!id) return notify('Anonymous profile');
    openProfileModal(id);
  });
  feed.querySelectorAll('.tag').forEach(t=> t.onclick = ()=> { document.getElementById('topicSelect').value = t.getAttribute('data-tag'); renderFeed(); });
}

/* Helpers */
function getUserDisplay(id){
  if(!id) return 'Anonymous';
  const u = state.users.find(x=>x.id===id);
  return u ? u.displayName : 'User';
}

/* Like toggling */
function toggleLike(postId){
  if(!state.currentUserId){ if(!confirm('Login to like? Quick register?')) return; quickRegister(); }
  const post = state.posts.find(p=>p.id===postId);
  if(!post) return;
  const idx = (post.likes||[]).indexOf(state.currentUserId);
  if(idx === -1){ post.likes.push(state.currentUserId); // award xp to author
    if(post.authorId){
      const a = state.users.find(u=>u.id===post.authorId); if(a) a.xp = (a.xp||0) + 3;
    }
    addNotification(post.authorId, `${getUserDisplay(state.currentUserId)} liked your post`);
    notify('Liked');
  } else { post.likes.splice(idx,1); notify('Unliked'); }
  save(); renderAll();
}

/* Bookmark */
function toggleBookmark(postId){
  if(!state.currentUserId){ if(!confirm('Login to bookmark?')) return; quickRegister(); }
  state.bookmarks = state.bookmarks || [];
  if(state.bookmarks.includes(postId)){
    state.bookmarks = state.bookmarks.filter(x=>x!==postId);
    notify('Removed bookmark');
  } else {
    state.bookmarks.push(postId);
    notify('Bookmarked');
  }
  save(); renderBookmarks();
}

/* Comments */
function openCommentPrompt(postId){
  if(!state.currentUserId){ if(!confirm('Login to comment?')) return; quickRegister(); }
  const txt = prompt('Write your comment:');
  if(!txt) return;
  const post = state.posts.find(p=>p.id===postId);
  post.comments = post.comments || [];
  post.comments.push({id:uid('c'), from: state.currentUserId, txt, at: nowISO()});
  // notify
  addNotification(post.authorId, `${getUserDisplay(state.currentUserId)} commented: "${txt.slice(0,30)}"`);
  save();
  notify('Comment added');
  renderAll();
}

/* Share: copy to clipboard or navigator.share */
function sharePost(postId){
  const p = state.posts.find(x=>x.id===postId);
  if(!p) return;
  const txt = `${p.authorName}: ${p.content}\n— via Bharat Roast`;
  if(navigator.share){ navigator.share({text:txt}).catch(()=>{}); notify('Share dialog opened'); }
  else { navigator.clipboard.writeText(txt).then(()=> notify('Copied to clipboard')); }
}

/* Report flow */
let currentReportTarget = null;
function openReport(postId){ currentReportTarget = postId; document.getElementById('reportModal').classList.add('show'); }
document.getElementById('closeReportModal').onclick = ()=> document.getElementById('reportModal').classList.remove('show');
document.getElementById('submitReport').onclick = ()=> {
  const reason = document.getElementById('reportReason').value;
  state.reports.push({id:uid('r'), postId: currentReportTarget, reason, at: nowISO()});
  document.getElementById('reportModal').classList.remove('show');
  notify('Report submitted — will review (demo)');
  save();
};

/* -------------------------
   Stories
   ------------------------- */
function renderStories(){
  const row = document.getElementById('storiesRow');
  row.innerHTML = '';
  state.stories.forEach(s=>{
    const u = state.users.find(x=>x.id===s.authorId);
    const el = document.createElement('div');
    el.className = 'story';
    el.innerHTML = `<div style="font-weight:700">${sanitize(u?u.displayName:'Anon')}</div><div class="s-name">${timeAgo(s.createdAt)}</div>`;
    el.onclick = ()=> openStoryModal(s);
    row.appendChild(el);
  });
}
document.getElementById('newStory').onclick = ()=> {
  if(!state.currentUserId){ if(!confirm('Login to post stories?')) return; quickRegister(); }
  const txt = prompt('Write a short story (8-140 chars):');
  if(!txt) return;
  state.stories.unshift({id:uid('s'), authorId: state.currentUserId, title: txt.slice(0,40), createdAt: nowISO(), content: txt});
  save(); renderStories(); notify('Story posted');
};
function openStoryModal(s){ document.getElementById('storyTitle').innerText = `${getUserDisplay(s.authorId)} • ${s.title}`; document.getElementById('storyContent').innerText = s.content; document.getElementById('storyModal').classList.add('show'); }
document.getElementById('closeStoryModal').onclick = ()=> document.getElementById('storyModal').classList.remove('show');

/* -------------------------
   Profiles (modal) & follow
   ------------------------- */
function openProfileModal(userId){
  const user = state.users.find(u=>u.id===userId);
  if(!user) return notify('User not found');
  document.getElementById('profileName').innerText = user.displayName + (user.badges && user.badges.length ? ' • ' + user.badges.join(' ') : '');
  document.getElementById('profileUserMeta').innerText = `@${user.username} · ${user.bio || ''}\nFollowers: ${user.followers?user.followers.length:0} · Following: ${user.following?user.following.length:0} · XP: ${user.xp||0}`;
  const postsHtml = state.posts.filter(p=>p.authorId===user.id).map(p=>`<div style="padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03)"><div class="small">${timeAgo(p.createdAt)}</div><div>${sanitize(p.content.slice(0,140))}</div></div>`).join('');
  document.getElementById('profilePosts').innerHTML = postsHtml || '<div class="small muted">No posts yet</div>';
  document.getElementById('profileModal').classList.add('show');

  // add follow button dynamically
  let followBtn = document.getElementById('profileFollowBtn');
  if(!followBtn){
    followBtn = document.createElement('button');
    followBtn.id = 'profileFollowBtn';
    followBtn.className = 'btn';
    document.querySelector('#profileModal .modal').insertBefore(followBtn, document.getElementById('profilePosts'));
  }
  followBtn.innerText = (state.currentUserId && state.users.find(u=>u.id===state.currentUserId).following.includes(user.id)) ? 'Unfollow' : 'Follow';
  followBtn.onclick = ()=> {
    if(!state.currentUserId){ if(!confirm('Login to follow?')) return; quickRegister(); }
    const me = state.users.find(u=>u.id===state.currentUserId);
    if(me.following.includes(user.id)){ me.following = me.following.filter(x=>x!==user.id); user.followers = user.followers.filter(x=>x!==me.id); notify('Unfollowed'); }
    else { me.following.push(user.id); user.followers = user.followers || []; user.followers.push(me.id); notify('Followed'); addNotification(user.id, `${me.displayName} followed you`); }
    save(); renderAll(); openProfileModal(user.id);
  };
}
document.getElementById('closeProfileModal').onclick = ()=> document.getElementById('profileModal').classList.remove('show');

/* -------------------------
   Notifications
   ------------------------- */
function addNotification(userId, text){
  if(!userId) return;
  state.notifications.unshift({id:uid('n'), userId, text, read:false, at: nowISO()});
  save(); renderNotifCount();
}
function renderNotifCount(){
  const c = state.notifications.filter(n=> n.userId===state.currentUserId && !n.read).length;
  document.getElementById('notifCount').innerText = c ? `(${c})` : '';
}
document.getElementById('openNotif').onclick = ()=> {
  document.getElementById('notifDrawer').classList.add('open');
  renderNotifDrawer();
};
document.getElementById('closeNotifDrawer').onclick = ()=> document.getElementById('notifDrawer').classList.remove('open');
function renderNotifDrawer(){
  const root = document.getElementById('notifHistory');
  root.innerHTML = '';
  const list = state.notifications.filter(n=> n.userId===state.currentUserId);
  if(list.length===0) root.innerHTML = '<div class="small muted">No notifications</div>';
  list.forEach(n=>{
    const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px dashed rgba(255,255,255,0.02)';
    d.innerHTML = `<div style="font-weight:700">${sanitize(n.text)}</div><div class="small muted">${timeAgo(n.at)}</div>`;
    root.appendChild(d);
  });
  // mark read
  state.notifications.forEach(x=> { if(x.userId===state.currentUserId) x.read = true; });
  save(); renderNotifCount();
}

/* -------------------------
   Leaderboard & tags
   ------------------------- */
function renderLeaderboard(){
  const box = document.getElementById('leaderboardList');
  box.innerHTML = '';
  const sorted = state.users.slice().sort((a,b)=> (b.xp||0)-(a.xp||0));
  sorted.slice(0,8).forEach(u=>{
    const row = document.createElement('div');
    row.className = 'leaderboard-row';
    row.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><div class="avatar">${sanitize(u.displayName[0]||u.username[0])}</div><div>${sanitize(u.displayName)}</div></div><div class="small">XP: ${u.xp||0}</div>`;
    box.appendChild(row);
  });
}

/* Trending tags clickable wired in renderFeed */

/* -------------------------
   Explore grid
   ------------------------- */
document.getElementById('openExplore').onclick = ()=> {
  const modal = document.createElement('div');
  modal.className='modal-overlay show';
  modal.innerHTML = `<div class="modal"><div class="modal-header"><strong>Explore</strong><button class="ghost" id="closeExplore">Close</button></div><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));grid-gap:8px">${state.posts.slice(0,40).map(p=>`<div class="explore-item" data-id="${p.id}">${sanitize(p.content.slice(0,60))}</div>`).join('')}</div></div>`;
  document.body.appendChild(modal);
  modal.querySelector('#closeExplore').onclick = ()=> { document.body.removeChild(modal); };
  modal.querySelectorAll('.explore-item').forEach(it=> it.onclick = ()=> { const id = it.getAttribute('data-id'); sharePost(id); });
};

/* -------------------------
   Bookmarks
   ------------------------- */
function renderBookmarks(){
  const root = document.getElementById('bookmarkList');
  root.innerHTML = '';
  if(!state.bookmarks || state.bookmarks.length===0) root.innerHTML = '<div class="small muted">No bookmarks</div>';
  (state.bookmarks||[]).forEach(pid=>{
    const p = state.posts.find(x=>x.id===pid);
    if(!p) return;
    const el = document.createElement('div');
    el.style.padding='8px'; el.style.borderBottom='1px dashed rgba(255,255,255,0.02)';
    el.innerHTML = `<div style="font-weight:700">${sanitize(p.authorName)}</div><div class="small">${sanitize(p.content.slice(0,80))}</div>`;
    root.appendChild(el);
  });
}

/* -------------------------
   DMs (very simple)
   ------------------------- */
document.getElementById('openDMs').onclick = ()=> {
  document.getElementById('dmModal').classList.add('show');
  renderDMList();
};
document.getElementById('closeDMs').onclick = ()=> document.getElementById('dmModal').classList.remove('show');
function renderDMList(){
  const list = document.getElementById('dmList');
  list.innerHTML = '';
  state.dms.forEach(t=>{
    const partner = t.participants.find(x=>x!==state.currentUserId);
    const row = document.createElement('div');
    row.style.padding='8px'; row.style.borderBottom='1px dashed rgba(255,255,255,0.02)';
    row.innerHTML = `<div style="font-weight:700">${getUserDisplay(partner)}</div><div class="small">${t.messages && t.messages.length ? t.messages[t.messages.length-1].txt.slice(0,40) : 'No messages'}</div>`;
    row.onclick = ()=> openThread(t.threadId);
    list.appendChild(row);
  });
}
function openThread(threadId){
  const t = state.dms.find(x=>x.threadId===threadId);
  if(!t) return;
  const root = document.getElementById('dmThread');
  root.innerHTML = t.messages.map(m=>`<div style="padding:6px"><strong>${getUserDisplay(m.from)}</strong>: ${sanitize(m.txt)} <div class="u-xxs muted">${timeAgo(m.at)}</div></div>`).join('');
  document.getElementById('dmSend').onclick = ()=> {
    const txt = document.getElementById('dmInput').value.trim();
    if(!txt) return; t.messages.push({from: state.currentUserId, txt, at: nowISO()}); save(); renderDMList(); openThread(threadId); document.getElementById('dmInput').value=''; notify('Message sent');
  };
}

/* -------------------------
   AI roast generator (local templated)
   ------------------------- */
function generateAiRoast(){
  const templates = [
    "Unpopular take: {X} is the real {Y}.",
    "If {X} had a motto it'd be: '{Y}'.",
    "POV: {X} thinks they're {Y}.",
    "{X} be like '{Y}' and then we all clap.",
    "My mom said {X}; I said 'that's not a feature, it's a personality.'"
  ];
  const picks = ["parents", "Kota coaching", "that WhatsApp group", "college apps", "the wifi", "my teacher"];
  const adjectives = ["confused", "overhyped", "extra", "temporarily motivated", "lost in reels"];
  const t = templates[Math.floor(Math.random()*templates.length)];
  const out = t.replace('{X}', picks[Math.floor(Math.random()*picks.length)]).replace('{Y}', adjectives[Math.floor(Math.random()*adjectives.length)]);
  return out;
}

/* -------------------------
   Export / wipe
   ------------------------- */
function exportData(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'bharatroast-data.json'; a.click();
  URL.revokeObjectURL(url);
}
function wipeAll(){
  if(!confirm('Wipe local data? This will remove all posts and users.')) return;
  localStorage.removeItem(DBKEY);
  location.reload();
}
document.getElementById('exportBtn').onclick = exportData;
document.getElementById('wipeBtn').onclick = wipeAll;

/* -------------------------
   Demo filler
   ------------------------- */
document.getElementById('demoFill').onclick = ()=> { loadDemo(); renderAll(); notify('Demo loaded'); };
function loadDemo(){
  // add a few more posts + users
  for(let i=0;i<6;i++){
    const u = {id:uid('u'), username:'demo'+i, displayName:'Demo'+i, score:0, bio:'', following:[], followers:[], badges:[], xp: Math.floor(Math.random()*80)};
    state.users.push(u);
    state.posts.unshift({id:uid('p'), authorId:u.id, authorName:u.displayName, content:`Demo roast post #${i} — this app is getting spicy`, media:[], anonymous:false, likes:[], comments:[], flags:0, createdAt: nowISO(), tone:'savage', tags:[]});
  }
  save();
}

/* -------------------------
   Theme toggle (light mode)
   ------------------------- */
document.getElementById('toggleTheme').onclick = ()=> toggleTheme();
function toggleTheme(){
  const isLight = document.documentElement.style.getPropertyValue('--bg') !== '';
  // simply toggle variable (fast)
  if(document.body.classList.contains('light')){
    document.body.classList.remove('light');
    document.documentElement.style.removeProperty('--bg');
  } else {
    document.body.classList.add('light');
    document.documentElement.style.setProperty('--bg','#f7f7f8');
  }
  notify('Theme toggled');
}

/* -------------------------
   Misc UI wiring
   ------------------------- */
document.getElementById('floatingPost').onclick = ()=> { window.scrollTo({top:0,behavior:'smooth'}); document.getElementById('postContent').focus(); };
document.getElementById('clearBtn').onclick = ()=>{ document.getElementById('searchInput').value=''; document.getElementById('topicSelect').value=''; renderFeed(); };
document.getElementById('searchInput').oninput = ()=> renderFeed();
document.getElementById('sortSelect').onchange = ()=> renderFeed();
document.getElementById('topicSelect').onchange = ()=> renderFeed();
document.getElementById('openNotif').onclick = ()=> document.getElementById('notifDrawer').classList.toggle('open');

/* -------------------------
   Initial render
   ------------------------- */
function renderAll(){
  load(); seedIfEmpty();
  renderUserArea();
  renderFeed();
  renderStories();
  renderLeaderboard();
  renderBookmarks();
  renderNotifCount();
}
load(); seedIfEmpty(); renderAll();

/* -------------------------
   PWA service worker registration stub
   ------------------------- */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/sw.js').then(()=>console.log('sw registered (stub)')).catch(()=>{/* ignore */});
}
</script>
</body>
</html>
