<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>RoastAbit — Premium Social App</title>
<meta name="description" content="RoastAbit — prototype social app (local-only) with posts, stories, explore, DMs, and more."/>
<link rel="manifest" href="site.webmanifest">
<style>
  /* ---------------------------
     Base theme & utilities (Vibrant Dark Mode with Hot BG)
     --------------------------- */
  :root{
    /* New Palette: Deep Charcoal (for text/cards), FIERY ORANGE/YELLOW Accent */
    --bg-primary:#08080A; /* Used for base dark elements */
    --card:#1A0F03; /* Very dark card, slightly brown/red tint for warmth */
    --muted:#A0A0A9; 
    --accent:#FF8C00; /* Dark Orange/Hot */
    --accent-2:#FFD700; /* Gold/Yellow */
    --glass: rgba(255,255,255,0.05);
    --glass-fixed: rgba(26, 15, 3, 0.85); /* Dark, slightly tinted glass for fixed bars */
    --success:#08a045;
    --danger:#FF4D4F;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    --radius:16px; /* Larger radius for a softer look */
  }
  html,body{
    height:100%; margin:0;
    /* --- NEW FUN & HOT BACKGROUND (Keep) --- */
    background:
        /* 1. Base Fiery Gradient: Hot Orange to Red-Orange */
        linear-gradient(180deg, #FF6600 0%, #E64A19 100%);
    color:#e8eef6; /* Light text for contrast */
    overflow-x: hidden; /* CRITICAL: Prevent horizontal scroll */
  }
  *{
    box-sizing:border-box;
    transition: background-color 0.2s, box-shadow 0.2s, transform 0.1s;
  }
  img{max-width:100%;display:block}
  
  /* Main app container uses the grid layout (Desktop) */
  .app{
    max-width:1120px;
    margin:0 auto;
    padding:20px;
    min-height:100vh;
    display:grid;
    grid-template-columns:1fr 340px;
    gap:20px;
  }

  /* ---------------------------
     Mobile First Optimization (Instagram Inspired)
     --------------------------- */
  .bottom-nav{
    position: fixed; bottom: 0; left: 0; right: 0;
    display: none; /* Default hidden, show only on mobile */
    justify-content: space-around;
    align-items: center;
    padding: 10px 0;
    background: var(--glass-fixed);
    backdrop-filter: blur(12px); /* Premium glass effect */
    -webkit-backdrop-filter: blur(12px);
    border-top: 1px solid rgba(255,255,255,0.08);
    z-index: 10000;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.6);
  }
  .nav-btn{
    display: flex; flex-direction: column; align-items: center;
    background: none; border: none; color: var(--muted); cursor: pointer;
    font-size: 11px; font-weight: 500; padding: 4px;
    line-height: 1.2;
    transform: scale(1);
  }
  .nav-btn:active{ transform: scale(0.95); }
  .nav-btn .icon { font-size: 26px; }
  .nav-btn .icon-small{ font-size: 22px; }
  .nav-btn.active{ color: var(--accent-2); } /* Use gold for active accent */

  /* Media Query for mobile/tablet screens */
  @media(max-width:980px){
    .app{
      grid-template-columns:1fr; /* Single column layout */
      padding: 0 0 70px 0; /* NO horizontal padding on container */
      gap: 10px;
      max-width: 100vw; /* Ensure it respects viewport width */
    }
    .rightcol{
      display: none; /* Hide the whole right column */
    }
    .topbar{
      position: sticky; top: 0; z-index: 999;
      padding: 12px 16px; /* Add horizontal padding to topbar */
      background: var(--glass-fixed);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 0; /* Full width top bar */
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .topbar .row{
      display: none; /* Hide desktop buttons */
    }
    .bottom-nav{
      display: flex; /* Show bottom navigation */
    }
    /* Apply horizontal spacing to main content cards */
    .card:not(.topbar){
      margin: 0 16px 14px 16px;
    }
    /* Floating button adjusted to sit above the bottom nav */
    .post-floating{
      right: 20px; bottom: 80px;
      width: 54px; height: 54px;
      padding: 10px; font-size: 32px;
    }
    .composer{
      flex-direction: column;
    }
    .composer .compose-actions{
      flex-direction: row;
      min-width: unset;
      gap: 6px;
    }
    .composer .compose-actions button{
      flex: 1;
      padding: 8px 10px;
    }
    #postBtn{
      order: -1;
    }
    .drawer{
      width: 100%;
      right: -100%;
      transition: 0.3s ease-in-out;
    }
    .drawer.open{
      right: 0;
    }
  }


  /* Topbar (Desktop) */
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--card);border-radius:var(--radius);margin-bottom:8px;box-shadow:0 6px 24px rgba(0,0,0,0.45)}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#000;font-size:18px;letter-spacing:0.6px}
  .title{font-size:20px;font-weight:800}
  .subtitle{font-size:12px;color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center}

  /* Cards & layout */
  .card{
    /* Use a dark, slightly tinted background for the cards to stand out on the hot background */
    background:linear-gradient(180deg, #1C1204 0%, #1A0F03 100%);
    padding:16px;
    border-radius:var(--radius);
    margin-bottom:14px;
    box-shadow:0 10px 30px rgba(0,0,0,0.6);
    border: 1px solid rgba(255,255,255,0.05); /* subtle border */
  }
  .small{font-size:12px;color:var(--muted)}
  .btn{
    background:var(--accent-2); /* Use bright gold/yellow for main button */
    border:none;
    padding:10px 14px;
    border-radius:10px;
    color:#000; 
    cursor:pointer;
    font-weight:700;
    box-shadow:0 4px 10px rgba(255, 215, 0, 0.5); /* Yellow shadow */
  }
  .btn:active{transform:scale(0.98)}
  
  /* --- GHOST BUTTON VISIBILITY FIX --- */
  .ghost{
    background:transparent;
    /* Use a solid white/accent border for high contrast */
    border:1px solid rgba(255, 215, 0, 0.4); /* Accent-2 with 40% transparency */
    padding:10px 12px;
    border-radius:10px;
    color:#e8eef6; /* Use main text color (light) for visibility */
    cursor:pointer;
    font-weight: 500;
  }
  .ghost:hover{background:rgba(255, 215, 0, 0.1); color: #fff;} /* Light background tint on hover */
  .ghost:active{transform:scale(0.98)}
  /* --- END GHOST BUTTON FIX --- */

  /* Composer */
  .composer{display:flex;gap:16px;align-items:flex-start}
  .composer textarea{
    width:100%; min-height:90px;
    padding:12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.08);
    background:rgba(0,0,0,0.3); /* Darker input */
    color:inherit;
    resize:vertical;
    font-size:15px;
  }
  .composer .compose-actions{display:flex;flex-direction:column;gap:10px;min-width:160px}

  /* Feed */
  .feed{display:flex;flex-direction:column;gap:16px}
  .post{
    padding:16px;
    border-radius:var(--radius);
    background:linear-gradient(180deg,#1F1406, #1A0F03); /* Slightly deeper background for posts */
    border:1px solid rgba(255,255,255,0.04);
  }
  .post:hover{
    box-shadow:0 12px 35px rgba(0,0,0,0.8);
    transform: translateY(-2px);
  }
  .meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .author{font-weight:700;font-size:16px}
  .time{font-size:12px;color:var(--muted)}
  .content{white-space:pre-wrap;margin:10px 0;font-size:15px;line-height:1.6}
  .actions{display:flex;gap:12px;align-items:center;margin-top:10px}
  .icon-btn{
    background:rgba(255,255,255,0.04);
    border:none;
    padding:8px 12px;
    border-radius:8px;
    color:var(--muted);
    cursor:pointer;
    font-weight:600;
  }
  .icon-btn:hover{background:rgba(255,255,255,0.08);}
  .icon-btn.active{background:var(--accent);color:#000;box-shadow:0 2px 8px rgba(255, 140, 0, 0.7);} /* Text color set to black here too */
  .badge{background:var(--accent-2);padding:4px 10px;border-radius:999px;font-size:12px;color:#000;font-weight:700}
  
  /* Right column specifics (still used on desktop) */
  .rightcol .card{position:sticky;top:20px}
  .template{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);cursor:pointer;border:1px dashed rgba(255,255,255,0.05);font-size:14px}
  .template:hover{background:rgba(255,255,255,0.06);}
  .leaderboard-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed rgba(255,255,255,0.03)}

  /* Floating Button */
  .post-floating{
    position:fixed;
    right:24px;
    bottom:24px;
    background:linear-gradient(135deg,var(--accent),var(--accent-2));
    border:none;
    padding:16px;
    border-radius:50%;
    font-weight:800;
    color:#000; /* Text color set to black */
    box-shadow:0 12px 40px rgba(0,0,0,0.8);
    cursor:pointer;
    z-index: 9999;
    font-size: 34px;
    line-height: 1;
  }

  /* Notifications */
  .notif{position:fixed;left:50%;transform:translateX(-50%);top:24px;background:var(--success);padding:12px 20px;border-radius:12px;color:#fff;display:none;z-index: 10001; font-weight: 600;}
  .danger-notif{background:var(--danger)}

  /* Tags */
  .tag{display:inline-block;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.08);font-size:13px;color:#fff;font-weight:500;margin-right:8px;cursor:pointer}
  .tag:hover{background:rgba(255,255,255,0.15);}

  /* Stories */
  .stories{display:flex;gap:12px;overflow-x:auto;padding:6px 0; /* Add overflow-x here */ }
  .story{min-width:80px;height:110px;border-radius:14px;background:linear-gradient(180deg,#161616,#121212);display:flex;align-items:flex-end;padding:10px;color:#fff;cursor:pointer;border:3px solid var(--accent); position: relative; overflow: hidden;}
  .story.read{border-color:rgba(255,255,255,0.1)}
  .story .s-name{font-size:12px;color:#fff;font-weight:700; text-shadow: 0 1px 3px rgba(0,0,0,0.8);}

  /* Explore grid */
  .explore-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));grid-gap:10px}
  .explore-item{border-radius:12px;overflow:hidden;background:linear-gradient(180deg,#111,#0b0b0c);height:120px;display:flex;align-items:center;justify-content:center;color:var(--muted);font-weight:700;padding:10px;text-align:center;border:1px solid rgba(255,255,255,0.05);}

  /* Modal/drawer */
  .drawer{position:fixed;right:-360px;top:0;height:100%;width:360px;background:#111;border-left:1px solid #333;padding:18px;transition:0.35s cubic-bezier(0.2, 0.8, 0.2, 1);overflow-y:auto;z-index:9999}
  .drawer.open{right:0}
  .modal-overlay{display:none;position:fixed;top:0;left:0;height:100%;width:100%;background:rgba(0,0,0,0.8);backdrop-filter:blur(6px);align-items:center;justify-content:center;z-index:99999}
  .modal-overlay.show{display:flex}
  .modal{background:#121214;padding:20px;border-radius:20px;width:90%;max-width:560px;max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.8);}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}

  /* tiny UX */
  .skeleton{background:linear-gradient(90deg,#121214,#0f0f10);height:16px;border-radius:8px;opacity:0.6}
  .muted{color:var(--muted)}
  footer{opacity:0.6;text-align:center;margin-top:40px;padding-bottom: 20px; font-size:13px;color:#fff; text-shadow: 0 1px 4px rgba(0,0,0,0.8);} /* Force footer text white/light for visibility */
  .u-xxs{font-size:11px;color:var(--muted)}
  .avatar{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#000;font-size:20px}
  input[type=file]{display:none}
  .media-preview{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .media-thumb{width:110px;height:80px;object-fit:cover;border-radius:10px;border:2px solid rgba(255,255,255,0.1)}
  .level{font-weight:800;color:var(--accent-2)}
  .search{
    padding:10px;border-radius:12px;
    border:1px solid rgba(255,255,255,0.08);
    background:rgba(0,0,0,0.3);
    color:inherit;
  }
</style>
</head>
<body>
<div class="notif" id="notif"></div>

<div class="topbar card">
  <div class="brand">
    <div class="logo">RA</div>
    <div>
      <div class="title">RoastAbit</div>
      <div class="subtitle">India's truth & roast feed</div>
    </div>
  </div>

  <div class="row">
    <button id="openExplore" class="ghost">🔍 Explore</button>
    <button id="openNotif" class="ghost">🔔 <span id="notifCount" style="margin-left:6px"></span></button>
    <button id="openDMs" class="ghost">✉️ DMs</button>
    <div id="user-area"></div>
  </div>
</div>

<div class="app" id="app">

  <div style="min-width: 0;">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Create Post</strong><div class="small">Share a truth, roast or image — keep it kind of spicy</div></div>
        <div class="small">Character safe: 1200</div>
      </div>
      <div style="height:12px"></div>
      <div class="composer">
        <div style="flex:1">
          <textarea id="postContent" placeholder="Write a roast or truth..."></textarea>
          <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:10px">
            <label style="display:flex;gap:6px;align-items:center"><input id="postAnon" type="checkbox" checked /> <span class="small">Post anonymously</span></label>
            <select id="postTone" class="ghost" style="flex-grow:0; padding: 6px 10px;">
              <option value="witty">Witty</option>
              <option value="savage">Savage</option>
              <option value="chill">Chill</option>
              <option value="flirty">Flirty</option>
              <option value="royal">Royal</option>
            </select>

            <div style="flex:1"></div>

            <label for="mediaUpload" class="icon-btn" style="cursor:pointer; font-size:14px; font-weight: 600;">🖼️ Add Media</label>
            <input id="mediaUpload" type="file" accept="image/*" multiple>
          </div>
          <div class="media-preview" id="mediaPreview"></div>
        </div>

        <div class="compose-actions">
          <button class="btn" id="postBtn">Post</button>
          <button class="ghost" id="aiRoastBtn">🤖 AI Roast</button>
          <button class="ghost" id="clearComposer">Clear</button>
          <div class="small muted" style="text-align: center;">Ctrl+Enter to post</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Stories</strong><div class="small">Short roasts & moments</div></div>
        <button id="newStory" class="ghost">+ Add</button>
      </div>
      <div class="stories" id="storiesRow" aria-label="Stories list"></div>
    </div>

    <div style="display:flex;gap:8px;margin:16px 16px 10px 16px; align-items: center; justify-content: space-between;">
      <input id="searchInput" class="search" placeholder="Search feed text, tags or author..." style="flex:1" />
      <select id="sortSelect" class="ghost" title="Sort" style="flex-grow:0; padding: 6px 10px;">
        <option value="new">Newest</option>
        <option value="top">Top (likes)</option>
      </select>
      <select id="topicSelect" class="ghost" style="flex-grow:0; padding: 6px 10px;">
        <option value="">All</option>
        <option>Parents</option><option>SchoolLife</option><option>KotaTruths</option><option>Dating</option><option>Bollywood</option>
      </select>
    </div>

    <div id="feed" class="feed"></div>

    <button class="post-floating" id="floatingPost">➕</button>

    <div id="loadingMore" style="display:none;margin-top:16px">
      <div class="card"><div class="skeleton" style="width:70%"></div><div style="height:10px"></div><div class="skeleton" style="width:90%"></div></div>
    </div>

  </div>

  <div class="rightcol">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div><strong>Trending Tags</strong><div class="small">What's being roasted</div></div>
        <button id="clearBtn" class="ghost">Clear</button>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:8px" id="trendingTags">
        <div class="tag" data-tag="Parents">#Parents</div>
        <div class="tag" data-tag="SchoolLife">#SchoolLife</div>
        <div class="tag" data-tag="KotaTruths">#KotaTruths</div>
        <div class="tag" data-tag="Dating">#Dating</div>
        <div class="tag" data-tag="Bollywood">#Bollywood</div>
      </div>
    </div>

    <div class="card">
      <strong>Roast Duel Arena</strong>
      <div class="small" style="margin-top:8px">Choose your format for the ultimate roast battle</div>
      <div style="margin-top:12px;display:grid;grid-template-columns:1fr;gap:10px">
        <div class="template" data-t="I'm about to drop a roast on {Topic} and need a partner. Who's in?">The Setup Roast (Partner Needed)</div>
        <div class="template" data-t="Unpopular Roast: {Target} is secretly good at {Skill} but nobody noticed.">Hidden Talent Roast</div>
        <div class="template" data-t="The truth is, {Person} is trying too hard to be {Adjective}.">Trying Too Hard Truth</div>
        <div class="template" data-t="Challenge: Roast [A] using only compliments.">The Compliment Roast</div>
        <div class="template" data-t="If my parents saw my bank balance they'd...">Money truth format</div>
      </div>
    </div>

    <div class="card">
      <strong>Leaderboard</strong>
      <div class="small" style="margin-top:8px">Top witty users (by likes)</div>
      <div id="leaderboardList" style="margin-top:12px"></div>
    </div>

    <div class="card">
      <strong>Settings & Tools</strong>
      <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
        <button class="ghost" id="demoFill">Load Demo Posts</button>
        <button class="ghost" id="exportBtn">Export Data (JSON)</button>
        <button class="ghost" id="wipeBtn" style="color:var(--danger); border-color: rgba(255, 77, 79, 0.3);">Wipe All Local Data</button>
      </div>
    </div>

  </div>
</div>

<footer>Built for rapid MVP testing — local only. Later: Firebase backend, AI meme generator, monetization.</footer>

<div class="bottom-nav" id="bottomNav">
  <button class="nav-btn" onclick="window.scrollTo({top:0,behavior:'smooth'});" title="Feed">
    <span class="icon">🏠</span>
    <span>Feed</span>
  </button>
  <button class="nav-btn" id="mobileOpenExplore" title="Explore">
    <span class="icon">✨</span>
    <span>Explore</span>
  </button>
  <button class="nav-btn" id="mobileOpenDMs" title="DMs">
    <span class="icon-small">💬</span>
    <span>Messages</span>
  </button>
  <button class="nav-btn" id="mobileOpenNotif" title="Notifications">
    <span class="icon-small">🔔</span>
    <span>Notifs<span id="mobileNotifCount"></span></span>
  </button>
  <button class="nav-btn" id="mobileProfileNav" title="Profile">
    <span id="mobileProfileIcon" class="icon-small">👤</span>
    <span>Profile</span>
  </button>
</div>
<div id="notifDrawer" class="drawer" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <strong>🔔 Notifications</strong>
    <button class="ghost" id="closeNotifDrawer">Close</button>
  </div>
  <div id="notifHistory"></div>
</div>

<div id="profileModal" class="modal-overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-header">
      <strong id="profileName">Profile</strong>
      <button class="ghost" id="closeProfileModal">✖</button>
    </div>
    <div class="small" id="profileUserMeta"></div>
    <div id="mobile-user-area-controls" style="margin-top:15px;display:flex;flex-wrap:wrap;gap:8px;justify-content:space-between"></div>
    <h3 style="margin-top:20px; font-size:18px; border-top:1px dashed rgba(255,255,255,0.1); padding-top:15px;">My Posts</h3>
    <div id="profilePosts" style="margin-top:12px"></div>
  </div>
</div>

<div id="storyModal" class="modal-overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-header">
      <strong id="storyTitle">Story</strong>
      <button class="ghost" id="closeStoryModal">✖</button>
    </div>
    <div id="storyContent" style="font-size:18px; line-height: 1.8; padding: 10px;"></div>
  </div>
</div>

<div id="dmModal" class="modal-overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-header">
      <strong>Direct Messages</strong>
      <button class="ghost" id="closeDMs">Close</button>
    </div>
    <div style="display:flex;gap:12px;flex-direction: column;">
      <div style="border-bottom:1px solid rgba(255,255,255,0.05);padding-bottom:10px">
        <button class="ghost" id="startDmBtn" style="width: 100%; margin-bottom: 8px;">+ New Chat</button>
        <div id="dmList"></div>
      </div>
      <div style="flex:1">
        <div id="dmThread" style="max-height: 250px; overflow-y: auto; padding-bottom: 10px; border-radius: 10px; background: rgba(0,0,0,0.2);"></div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <input id="dmInput" placeholder="Write message..." class="search" style="flex:1" />
          <button id="dmSend" class="btn">Send</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="reportModal" class="modal-overlay" aria-hidden="true">
  <div class="modal">
    <div class="modal-header">
      <strong>Report Post</strong>
      <button class="ghost" id="closeReportModal">✖</button>
    </div>
    <div class="small">Why are you reporting?</div>
    <select id="reportReason" class="search" style="margin-top:12px;width:100%">
      <option>Harassment</option>
      <option>Hate Speech</option>
      <option>Misleading Info</option>
      <option>Spam / Promotion</option>
      <option>NSFW</option>
    </select>
    <button id="submitReport" class="btn" style="margin-top:15px;width:100%">Submit Report</button>
  </div>
</div>

<script>
/* ==================================================
   RoastAbit — Expanded Single-file Frontend Prototype
   ================================================== */

/* -------------------------
   Storage key & initial state
   ------------------------- */
const DBKEY = 'bharat_roast_super_v3';
let state = {
  users: [],
  posts: [],
  stories: [],
  dms: [],
  notifications: [],
  currentUserId: null,
  bookmarks: [],
  reports: []
};

/* -------------------------
   Utilities
   ------------------------- */
function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,10); }
function nowISO(){ return new Date().toISOString(); }
function save(){ localStorage.setItem(DBKEY, JSON.stringify(state)); }
function load(){
  const raw = localStorage.getItem(DBKEY);
  if(raw){ try{ state = JSON.parse(raw); } catch(e){ console.error(e); localStorage.removeItem(DBKEY); } }
  // Ensure all keys exist
  state.users = state.users || [];
  state.posts = state.posts || [];
  state.stories = state.stories || [];
  state.dms = state.dms || [];
  state.notifications = state.notifications || [];
  state.bookmarks = state.bookmarks || [];
  state.reports = state.reports || [];
}
function notify(msg, danger=false){
  const n = document.getElementById('notif');
  n.innerText = msg; n.style.display='block';
  n.className = danger? 'notif danger-notif' : 'notif';
  setTimeout(()=> n.style.display='none', 2000);
}
function timeAgo(iso){
  const d = new Date(iso); const diff = Date.now() - d.getTime();
  if(diff < 60000) return Math.round(diff/1000) + 's';
  if(diff < 3600000) return Math.round(diff/60000) + 'm';
  if(diff < 86400000) return Math.round(diff/3600000) + 'h';
  return d.toLocaleDateString();
}
function sanitize(s){ return (s||'').replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* -------------------------
   Seed data if empty
   ------------------------- */
function seedIfEmpty(){
  if(state.users.length===0){
    const a = {id:uid('u'), username:'roastlord', displayName:'RoastLord', score:12, bio:'King of roasts', following:[], followers:[], badges:['OG'], xp:120};
    const b = {id:uid('u'), username:'savage_sai', displayName:'SavageSai', score:9, bio:'Sarcastic but kind', following:[], followers:[], badges:[], xp:80};
    const c = {id:uid('u'), username:'anonfan', displayName:'AnonFan', score:3, bio:'lurking', following:[], followers:[], badges:[], xp:10};
    state.users.push(a,b,c);
    state.currentUserId = a.id; // Auto-login first user for demo
  }
  if(state.posts.length===0){
    state.posts.push(
      {id:uid('p'), authorId:state.users[0].id, authorName:state.users[0].displayName, content:'Indian parents: "Beta phone mat chalao" — also watching reels at 2AM 😂', media:[], anonymous:false, likes:[state.users[1].id], comments:[{id:uid('c'), from:state.users[1].id, txt:'Facts!', at:nowISO()}], flags:0, createdAt:new Date(Date.now()-3600*1000*6).toISOString(), tone:'witty', tags:['Parents']},
      {id:uid('p'), authorId:null, authorName:'Anonymous', content:"School taught us Pythagoras but not how to handle relatives 😭", media:[], anonymous:true, likes:[], comments:[], flags:0, createdAt:new Date(Date.now()-3600*1000*2).toISOString(), tone:'savage', tags:['SchoolLife']},
      {id:uid('p'), authorId:state.users[1].id, authorName:state.users[1].displayName, content:"Unpopular opinion: Kota motivation is temporary consumerism of hope", media:[], anonymous:false, likes:[state.users[0].id], comments:[], flags:0, createdAt:new Date(Date.now()-3600*1000*1).toISOString(), tone:'chill', tags:['KotaTruths']}
    );
  }
  if(state.stories.length===0){
    state.stories.push({id:uid('s'), authorId:state.users[0].id, title:'Roast clip', createdAt:nowISO(), content:'Short roast story — 8s text'});
  }
  save();
}

/* -------------------------
   Render: user area (desktop) and mobile profile controls
   ------------------------- */
function renderUserArea(){
  const ua = document.getElementById('user-area');
  const mca = document.getElementById('mobile-user-area-controls');
  ua.innerHTML = '';
  mca.innerHTML = '';

  if(state.currentUserId){
    const u = state.users.find(x=>x.id===state.currentUserId);
    if(!u){ state.currentUserId = null; save(); renderUserArea(); return; }

    // Desktop view
    const elDesk = document.createElement('div');
    elDesk.innerHTML = `<div style="display:flex;align-items:center;gap:10px">
      <div class="avatar" style="width:36px;height:36px;font-size:16px">${sanitize(u.displayName[0]||'U')}</div>
      <div style="text-align:right">
        <div style="font-weight:700; font-size: 14px;">${sanitize(u.displayName)}</div>
        <div class="small">@${sanitize(u.username)}</div>
      </div>
      <button class="ghost" id="logoutBtnDesk" style="padding: 8px 10px; font-size: 14px;">Logout</button>
    </div>`;
    ua.appendChild(elDesk);
    document.getElementById('logoutBtnDesk').onclick = ()=>{ state.currentUserId = null; save(); renderAll(); notify('Logged out') };

    // Mobile Profile View Controls (rendered inside the profile modal)
    mca.innerHTML = `
      <button class="btn" id="logoutBtnMobile" style="background: var(--danger); box-shadow: none;">Logout</button>
      <button class="ghost" id="exportBtnModal">Export</button>
      <button class="ghost" id="wipeBtnModal">Wipe Data</button>
    `;
    document.getElementById('logoutBtnMobile').onclick = ()=>{ state.currentUserId = null; save(); renderAll(); notify('Logged out'); document.getElementById('profileModal').classList.remove('show'); };
    document.getElementById('exportBtnModal').onclick = exportData;
    document.getElementById('wipeBtnModal').onclick = wipeAll;

    // Set mobile profile icon
    document.getElementById('mobileProfileIcon').innerText = sanitize(u.displayName[0]||'U');
    document.getElementById('mobileProfileIcon').style.backgroundColor = 'var(--accent-2)';
    document.getElementById('mobileProfileIcon').style.color = '#000';
    document.getElementById('mobileProfileIcon').style.borderRadius = '50%';

  } else {
    // Desktop View
    const elDesk = document.createElement('div');
    elDesk.innerHTML = `<div style="display:flex;gap:8px">
      <button class="ghost" id="quickRegDesk">Join</button>
      <button class="btn" id="openLoginDesk">Login</button>
    </div>`;
    ua.appendChild(elDesk);
    document.getElementById('quickRegDesk').onclick = quickRegister;
    document.getElementById('openLoginDesk').onclick = showLoginPrompt;

    // Mobile Profile View Controls (Non-logged in)
    mca.innerHTML = `
      <button class="btn" id="quickRegMobile">Quick Join</button>
      <button class="ghost" id="openLoginMobile">Login</button>
    `;
    document.getElementById('quickRegMobile').onclick = quickRegister;
    document.getElementById('openLoginMobile').onclick = showLoginPrompt;

    // Set mobile profile icon back to default
    document.getElementById('mobileProfileIcon').innerText = '👤';
    document.getElementById('mobileProfileIcon').style.backgroundColor = 'transparent';
    document.getElementById('mobileProfileIcon').style.color = 'var(--muted)';
  }
}

/* ------------------------- Composer handlers ------------------------- */
let stagedMedia = [];
document.getElementById('mediaUpload').addEventListener('change', (e)=>{
  const files = Array.from(e.target.files || []);
  if(stagedMedia.length + files.length > 4) {
    notify('Max 4 images allowed', true);
    return;
  }
  files.forEach(f=>{
    const reader = new FileReader();
    reader.onload = (e) => {
      stagedMedia.push({id: uid('m'), src: e.target.result});
      renderMediaPreview();
    };
    reader.readAsDataURL(f);
  });
});

function renderMediaPreview(){
  const root = document.getElementById('mediaPreview');
  root.innerHTML = '';
  stagedMedia.forEach(m=>{
    const el = document.createElement('div');
    el.style.position = 'relative';
    el.innerHTML = `<img src="${m.src}" class="media-thumb" /><button style="position:absolute;top:5px;right:5px;background:rgba(0,0,0,0.6);border:none;border-radius:50%;color:#fff;width:20px;height:20px;line-height:1;font-size:12px;cursor:pointer" data-id="${m.id}">✖</button>`;
    root.appendChild(el);
  });
  root.querySelectorAll('button').forEach(b=>{
    b.onclick = (e)=>{
      const id = e.target.getAttribute('data-id');
      stagedMedia = stagedMedia.filter(m=>m.id !== id);
      renderMediaPreview();
    }
  });
}

document.getElementById('clearComposer').onclick = ()=>{
  document.getElementById('postContent').value = '';
  stagedMedia = [];
  renderMediaPreview();
  notify('Composer cleared');
}

/* AI Roast Feature (Demo Stub) */
document.getElementById('aiRoastBtn').onclick = ()=>{
  const content = document.getElementById('postContent').value.trim();
  if(!content) return notify('Write something first to roast', true);
  
  // Simple demo AI logic
  const roast = `*AI ROAST:* That's a decent thought, but the roast factor is only 3/10. Needs more spice. Try adding a dash of the 'savage' tone and mentioning 'chai' or 'Sharma ji ka beta'.`;
  document.getElementById('postContent').value = content + '\n\n' + roast;
  notify('AI Roast suggested!');
}

/* ------------------------- User authentication (Local only stub) ------------------------- */
function quickRegister(){
  const uname = 'guest_' + uid().slice(0,6);
  if(state.users.find(u=>u.username === uname)) return quickRegister(); // Retry if somehow duplicates
  const user = {id:uid('u'), username: uname, displayName: uname, score: 0, bio:`A new roaster from the RoastAbit community.`, following:[], followers:[], badges:['Newbie'], xp:0 };
  state.users.push(user);
  state.currentUserId = user.id;
  save();
  renderAll();
  notify('Quick account created: @' + uname);
}

function showLoginPrompt(){
  const uname = prompt('Enter username (registered):');
  if(!uname) return;
  const user = state.users.find(u=>u.username === uname);
  if(!user){
    if(confirm('User not found. Create new user with this username?')) {
      const newu = {id:uid('u'), username: uname, displayName: uname, score: 0, bio:`A new roaster from the RoastAbit community.`, following:[], followers:[], badges:['Newbie'], xp:0};
      state.users.push(newu);
      state.currentUserId = newu.id;
      save();
      renderAll();
      notify('Account created');
      return;
    } else {
      return;
    }
  }
  state.currentUserId = user.id;
  save();
  renderAll();
  notify('Logged in as @' + user.username);
}

/* Post creation */
document.getElementById('postBtn').onclick = handlePost;
document.getElementById('postContent').addEventListener('keydown', (e)=> {
  if(e.ctrlKey && e.key==='Enter') handlePost();
});

function handlePost(){
  const content = document.getElementById('postContent').value.trim();
  if(!content && stagedMedia.length===0) return notify('Type something or add media', true);

  const anon = document.getElementById('postAnon').checked;
  const tone = document.getElementById('postTone').value;

  if(!state.currentUserId && !confirm('You are not logged in. Post will be anonymous. Continue?')) return;

  const author = state.users.find(u=>u.id===state.currentUserId);

  const post = {
    id: uid('p'),
    authorId: anon ? null : (author? author.id : null),
    authorName: anon ? 'Anonymous Roaster' : (author? author.displayName : 'Anonymous Roaster'),
    content,
    media: stagedMedia.map(m=>({id:m.id, src:m.src})),
    anonymous: !!anon,
    likes: [],
    comments: [],
    flags: 0,
    createdAt: nowISO(),
    tone,
    tags: extractTags(content)
  };

  state.posts.unshift(post);
  stagedMedia = [];
  renderMediaPreview();

  // award xp
  if(author){
    author.xp = (author.xp||0) + 5;
  }

  save();
  document.getElementById('postContent').value = '';
  notify('Posted successfully');
  renderAll();
}

/* Tags extract: simple # or keywords mapping */
function extractTags(text){
  const tagset = [];
  const rx = /#([A-Za-z0-9_]+)/g;
  let m;
  while((m = rx.exec(text)) !== null){
    tagset.push(m[1]);
  }
  if(/parents/i.test(text) && !tagset.includes('Parents')) tagset.push('Parents');
  if(/dating/i.test(text) && !tagset.includes('Dating')) tagset.push('Dating');
  return tagset;
}

/* ------------------------- Rendering feed & actions ------------------------- */
function renderFeed(){
  const feed = document.getElementById('feed');
  feed.innerHTML = '';

  const q = (document.getElementById('searchInput').value || '').toLowerCase();
  const sort = document.getElementById('sortSelect').value;
  const topic = (document.getElementById('topicSelect').value || '').toLowerCase();

  const filteredPosts = state.posts.filter(p=>{
    const matchesQuery = !q || p.content.toLowerCase().includes(q) || (p.tags||[]).some(t=> t.toLowerCase().includes(q)) || p.authorName.toLowerCase().includes(q);
    const matchesTopic = !topic || (p.tags||[]).some(t=> t.toLowerCase() === topic);
    return matchesQuery && matchesTopic;
  });

  filteredPosts.sort((a,b)=>{
    if(sort==='top') return (b.likes.length || 0) - (a.likes.length || 0);
    return new Date(b.createdAt) - new Date(a.createdAt);
  });
  
  // Helper to resolve user name or use fallback
  function getUserDisplay(userId){
    const user = state.users.find(u=>u.id === userId);
    return sanitize(user ? user.displayName : 'Unknown User');
  }

  // Helper to get avatar details
  function getAvatarDetails(post){
    if(post.anonymous || !post.authorId){
      return { isAnon: true, avatarText: '?', authorDisplay: 'Anonymous Roaster' };
    }
    const user = state.users.find(u=>u.id === post.authorId);
    return { 
      isAnon: false, 
      avatarText: sanitize(user? user.displayName[0] : 'U'), 
      authorDisplay: sanitize(user? user.displayName : 'Deleted User')
    };
  }

  filteredPosts.forEach(p=>{
    const el = document.createElement('div');
    el.className = 'post card';
    const userAvatar = getAvatarDetails(p);
    const authorDisplay = userAvatar.authorDisplay;
    const likeCount = p.likes.length || 0;
    const tone = p.tone.toUpperCase().substring(0,1) + p.tone.substring(1);
    
    const mediaHtml = (p.media && p.media.length > 0) 
      ? `<div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">${p.media.map(m=>`<img src="${m.src}" style="width:100%;max-height: 250px;object-fit:cover;border-radius:8px">`).join('')}</div>` : '';

    el.innerHTML = `
      <div class="meta">
        <div style="display:flex;gap:12px;align-items:center">
          <div class="avatar" style="cursor:pointer; width:40px;height:40px;font-size:16px; border-radius:50%" data-user="${p.authorId || ''}">${userAvatar.avatarText}</div>
          <div>
            <div class="author" style="cursor:pointer" data-user="${p.authorId || ''}">${sanitize(authorDisplay)} ${userAvatar.isAnon ? ' <span class="small">(Anon)</span>' : ''}</div>
            <div class="small">${timeAgo(p.createdAt)} · <span class="level" style="color:var(--accent-2); font-weight:700">${sanitize(tone)}</span></div>
          </div>
        </div>
        <div class="small">${likeCount} ❤️</div>
      </div>
      <div class="content">${sanitize(p.content)}</div>
      ${mediaHtml}
      <div style="margin-top:12px">${(p.tags||[]).map(t=>`<span class="tag" data-tag="${t}" style="padding: 4px 8px; font-size:12px">${sanitize(t)}</span>`).join(' ')}</div>
      <div class="actions">
        <button class="icon-btn like-btn ${p.likes && p.likes.includes(state.currentUserId) ? 'active' : ''}" data-id="${p.id}">${p.likes && p.likes.includes(state.currentUserId) ? '❤️ Liked' : '🤍 Like'}</button>
        <button class="icon-btn comment-btn" data-id="${p.id}">💬 Comment</button>
        <button class="icon-btn share-btn" data-id="${p.id}">⤴ Share</button>
        <button class="icon-btn bookmark-btn" data-id="${p.id}">${state.bookmarks && state.bookmarks.includes(p.id) ? '📌 Saved' : '🔖 Save'}</button>
        <button class="icon-btn report-btn" data-id="${p.id}">⚑ Report</button>
      </div>
      <div class="small" style="margin-top:12px" id="comments-${p.id}">${(p.comments||[]).slice(0,2).map(c=>`<div><strong>${getUserDisplay(c.from)}</strong> · ${sanitize(c.txt)}</div>`).join('')}${(p.comments&&p.comments.length>2?`<div class="u-xxs muted" style="margin-top:4px;">+${p.comments.length-2} more comments</div>`:'')}</div>
    `;
    feed.appendChild(el);
  });

  // Wire up buttons
  feed.querySelectorAll('.like-btn').forEach(b=> b.onclick = ()=> toggleLike(b.getAttribute('data-id')) );
  feed.querySelectorAll('.comment-btn').forEach(b=> b.onclick = ()=> openCommentPrompt(b.getAttribute('data-id')) );
  feed.querySelectorAll('.share-btn').forEach(b=> b.onclick = ()=> sharePost(b.getAttribute('data-id')) );
  feed.querySelectorAll('.bookmark-btn').forEach(b=> b.onclick = ()=> toggleBookmark(b.getAttribute('data-id')) );
  feed.querySelectorAll('.report-btn').forEach(b=> b.onclick = ()=> openReport(b.getAttribute('data-id')) );
  feed.querySelectorAll('.avatar, .author').forEach(b=> {
    if(b.getAttribute('data-user')) b.onclick = ()=> openProfileModal(b.getAttribute('data-user'));
  });
  feed.querySelectorAll('.tag').forEach(b=> b.onclick = ()=> {
    document.getElementById('topicSelect').value = b.getAttribute('data-tag');
    renderFeed();
  });
}

function renderLeaderboard(){
  const list = document.getElementById('leaderboardList');
  list.innerHTML = '';
  const sorted = state.users.slice().sort((a,b)=> (b.xp||0)-(a.xp||0)); // Sort by XP score
  sorted.slice(0,5).forEach((u, i)=>{
    const row = document.createElement('div');
    row.className = 'leaderboard-row';
    const rank = i+1;
    row.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><div class="avatar" style="width:30px;height:30px;font-size:14px">${rank}</div><div>${sanitize(u.displayName)}</div></div><div class="small">XP: ${u.xp||0}</div>`;
    list.appendChild(row);
  });
}

function toggleLike(postId){
  if(!state.currentUserId) return notify('Please login to like posts', true);
  const p = state.posts.find(x=>x.id===postId);
  if(!p) return;

  if(p.likes.includes(state.currentUserId)){
    p.likes = p.likes.filter(id=> id !== state.currentUserId);
    notify('Unliked');
  } else {
    p.likes.push(state.currentUserId);
    notify('Liked!');
    addNotification(p.authorId, `${state.users.find(u=>u.id===state.currentUserId).displayName} liked your post`);
    // award xp
    const author = state.users.find(u=>u.id===p.authorId);
    if(author){ author.xp = (author.xp||0) + 1; }
  }
  save();
  renderFeed();
  renderLeaderboard();
}

function toggleBookmark(postId){
  if(!state.currentUserId) return notify('Please login to save posts', true);
  if(state.bookmarks.includes(postId)){
    state.bookmarks = state.bookmarks.filter(id=> id !== postId);
    notify('Removed bookmark');
  } else {
    state.bookmarks.push(postId);
    notify('Bookmarked!');
  }
  save();
  renderFeed();
  if(document.getElementById('profileModal').classList.contains('show')) openProfileModal(state.currentUserId);
}

function openCommentPrompt(postId){
  if(!state.currentUserId) return notify('Please login to comment', true);
  const txt = prompt('Write your comment:');
  if(!txt || txt.length < 2) return;

  const post = state.posts.find(x=>x.id===postId);
  if(!post) return;
  post.comments.push({id:uid('c'), from: state.currentUserId, txt, at: nowISO()});

  addNotification(post.authorId, `${getUserDisplay(state.currentUserId)} commented: "${txt.slice(0,30)}"`);
  save();
  notify('Comment added');
  renderAll();
}

/* Share: copy to clipboard or navigator.share */
function sharePost(postId){
  const p = state.posts.find(x=>x.id===postId);
  if(!p) return;
  const txt = `${p.authorName}: ${p.content}\n— via RoastAbit`;

  if(navigator.share){
    navigator.share({text:txt}).catch(()=>{});
    notify('Share dialog opened');
  } else {
    navigator.clipboard.writeText(txt).then(()=> notify('Copied to clipboard')).catch(() => {
      // Fallback for security issues in iframe
      const el = document.createElement('textarea');
      el.value = txt;
      el.setAttribute('readonly', '');
      el.style.position = 'absolute';
      el.style.left = '-9999px';
      document.body.appendChild(el);
      el.select();
      try {
        document.execCommand('copy');
        notify('Copied to clipboard (fallback)');
      } catch(e) {
        notify('Failed to copy. Please copy manually.', true);
      }
      document.body.removeChild(el);
    });
  }
}

/* Report flow */
let currentReportTarget = null;
function openReport(postId){
  currentReportTarget = postId;
  document.getElementById('reportModal').classList.add('show');
}
document.getElementById('closeReportModal').onclick = ()=> document.getElementById('reportModal').classList.remove('show');
document.getElementById('submitReport').onclick = ()=> {
  const reason = document.getElementById('reportReason').value;
  state.reports.push({id:uid('r'), postId: currentReportTarget, reason, at: nowISO()});
  document.getElementById('reportModal').classList.remove('show');
  notify('Report submitted — will review (demo)');
  save();
};

/* ------------------------- Stories ------------------------- */
function renderStories(){
  const row = document.getElementById('storiesRow');
  row.innerHTML = '';
  state.stories.forEach(s=>{
    const u = state.users.find(x=>x.id===s.authorId);
    const el = document.createElement('div');
    el.className = 'story';
    el.innerHTML = `<div style="position:absolute; top: 10px; left: 10px; font-size: 14px;">▶️</div><div class="s-name">${sanitize(u?u.displayName:'Anon')}</div>`;
    el.onclick = ()=> openStoryModal(s);
    row.appendChild(el);
  });
}

document.getElementById('newStory').onclick = ()=> {
  if(!state.currentUserId){
    if(!confirm('Login to post stories?')) return;
    quickRegister();
    return;
  }
  const txt = prompt('Write a short story (max 140 chars):');
  if(!txt) return;
  state.stories.unshift({id:uid('s'), authorId: state.currentUserId, title: txt.slice(0,40), createdAt: nowISO(), content: txt});
  save();
  renderStories();
  notify('Story posted');
};

function openStoryModal(s){
  document.getElementById('storyTitle').innerText = `${getUserDisplay(s.authorId)}'s Story`;
  document.getElementById('storyContent').innerText = s.content;
  document.getElementById('storyModal').classList.add('show');
}
document.getElementById('closeStoryModal').onclick = ()=> document.getElementById('storyModal').classList.remove('show');

/* ------------------------- Profiles (modal) & follow ------------------------- */
function openProfileModal(userId){
  const user = state.users.find(u=>u.id===userId);
  if(!user) return notify('User not found');

  document.getElementById('profileName').innerText = sanitize(user.displayName);

  const followers = user.followers ? user.followers.length : 0;
  const following = user.following ? user.following.length : 0;
  const userPosts = state.posts.filter(p=>p.authorId===user.id);
  const badges = user.badges || [];
  
  document.getElementById('profileUserMeta').innerHTML = `
    <div style="margin-bottom: 8px;">
      <div class="avatar" style="width: 80px; height: 80px; font-size: 32px; margin: 0 auto 10px;">${sanitize(user.displayName[0]||'U')}</div>
      <div style="font-size:14px; text-align:center;">
        @${sanitize(user.username)} · XP: <span class="level">${user.xp||0}</span>
      </div>
    </div>
    <div style="display:flex;justify-content:center;gap:20px;margin-bottom:12px;font-weight:700">
      <div>${userPosts.length} Posts</div>
      <div>${followers} Followers</div>
      <div>${following} Following</div>
    </div>
    <div style="font-size:14px; text-align:center; color:#ddd; margin-bottom: 15px;">${sanitize(user.bio)}</div>
    <div style="text-align:center; margin-bottom: 15px;">
      ${badges.map(b=>`<span class="badge" style="margin-right:5px; background:var(--accent-2)">${b}</span>`).join('')}
    </div>
    <button class="btn" id="profileFollowBtn" style="width:100%; margin-top:10px"></button>
  `;

  // Render User Posts
  const profilePostsRoot = document.getElementById('profilePosts');
  profilePostsRoot.innerHTML = '';
  if(userPosts.length === 0){
    profilePostsRoot.innerHTML = `<div class="small muted">No posts yet.</div>`;
  } else {
    userPosts.slice(0,5).forEach(p=>{
      const el = document.createElement('div');
      el.className = 'post card'; // Use post card for styling consistency
      el.style.padding = '12px';
      el.style.marginBottom = '10px';
      el.innerHTML = `<div class="small">${timeAgo(p.createdAt)} · ${p.likes.length} ❤️</div><div class="content">${sanitize(p.content.slice(0, 150))}${p.content.length > 150 ? '...' : ''}</div>`;
      profilePostsRoot.appendChild(el);
    });
    if(userPosts.length > 5) profilePostsRoot.innerHTML += `<div class="small muted" style="text-align:center">+${userPosts.length-5} more posts</div>`;
  }

  document.getElementById('profileModal').classList.add('show');
  
  // Handle Follow Button
  let followBtn = document.getElementById('profileFollowBtn');
  if(userId === state.currentUserId) {
    followBtn.style.display = 'none';
    document.getElementById('mobile-user-area-controls').style.display = 'flex';
  } else {
    document.getElementById('mobile-user-area-controls').style.display = 'none';
    followBtn.style.display = 'block';
    followBtn.innerText = (state.currentUserId && state.users.find(u=>u.id===state.currentUserId) && state.users.find(u=>u.id===state.currentUserId).following.includes(user.id)) ? 'Unfollow' : 'Follow';
    followBtn.onclick = ()=> {
      if(!state.currentUserId){
        if(!confirm('Login to follow?')) return;
        quickRegister();
        return;
      }
      const me = state.users.find(u=>u.id===state.currentUserId);
      if(me.following.includes(user.id)){
        me.following = me.following.filter(x=>x!==user.id);
        user.followers = user.followers.filter(x=>x!==me.id);
        notify('Unfollowed');
      } else {
        me.following.push(user.id);
        user.followers = user.followers || [];
        user.followers.push(me.id);
        notify('Followed');
        addNotification(user.id, `${me.displayName} followed you`);
      }
      save();
      renderAll();
      openProfileModal(user.id);
    };
  }
}

document.getElementById('closeProfileModal').onclick = ()=> document.getElementById('profileModal').classList.remove('show');
document.getElementById('mobileProfileNav').onclick = ()=> {
  if(state.currentUserId) {
    openProfileModal(state.currentUserId);
  } else {
    document.getElementById('profileName').innerText = 'Account';
    document.getElementById('profileUserMeta').innerHTML = '<div style="text-align:center">Login or Quick Join to manage your profile and start roasting.</div>';
    document.getElementById('profilePosts').innerHTML = '';
    document.getElementById('mobile-user-area-controls').style.display = 'flex'; // Show login controls
    let followBtn = document.getElementById('profileFollowBtn');
    if(followBtn) followBtn.style.display = 'none';
    document.getElementById('profileModal').classList.add('show');
    renderUserArea();
  }
};

/* ------------------------- Notifications ------------------------- */
function addNotification(userId, text){
  if(!userId || userId === state.currentUserId) return;
  state.notifications.unshift({id:uid('n'), userId, text, read:false, at: nowISO()});
  save();
  renderNotifCount();
}

function renderNotifCount(){
  const c = state.notifications.filter(n=> n.userId===state.currentUserId && !n.read).length;
  const desktopCount = document.getElementById('notifCount');
  if(desktopCount) desktopCount.innerText = c ? `(${c})` : '';
  const mobileCount = document.getElementById('mobileNotifCount');
  if(mobileCount) mobileCount.innerText = c ? ` (${c})` : '';
}

document.getElementById('openNotif').onclick = ()=> {
  document.getElementById('notifDrawer').classList.add('open');
  renderNotifDrawer();
  state.notifications.filter(n=> n.userId===state.currentUserId).forEach(n=> n.read = true);
  save();
  renderNotifCount();
};
document.getElementById('mobileOpenNotif').onclick = document.getElementById('openNotif').onclick;
document.getElementById('closeNotifDrawer').onclick = ()=> document.getElementById('notifDrawer').classList.remove('open');

function renderNotifDrawer(){
  const root = document.getElementById('notifHistory');
  root.innerHTML = '';
  const list = state.notifications.filter(n=> n.userId===state.currentUserId).sort((a,b)=> new Date(b.at)-new Date(a.at));
  if(list.length===0) root.innerHTML = '<div class="small muted" style="padding: 10px;">No notifications</div>';
  list.forEach(n=>{
    const d = document.createElement('div');
    d.style.padding='10px';
    d.style.borderBottom='1px dashed rgba(255,255,255,0.05)';
    d.style.opacity = n.read ? 0.7 : 1;
    d.innerHTML = `<div style="font-weight:700">${sanitize(n.text)}</div><div class="small muted">${timeAgo(n.at)}</div>`;
    root.appendChild(d);
  });
}

/* ------------------------- DMs (modal) ------------------------- */
document.getElementById('openDMs').onclick = ()=> {
  if(!state.currentUserId) return notify('Please login to view DMs', true);
  renderDMList();
  document.getElementById('dmModal').classList.add('show');
};
document.getElementById('mobileOpenDMs').onclick = document.getElementById('openDMs').onclick;
document.getElementById('closeDMs').onclick = ()=> document.getElementById('dmModal').classList.remove('show');

function renderDMList(){
  const list = document.getElementById('dmList');
  list.innerHTML = '';
  const myThreads = state.dms.filter(t=> t.participants.includes(state.currentUserId)).sort((a,b)=> new Date(b.messages.slice(-1)[0].at) - new Date(a.messages.slice(-1)[0].at));

  if(myThreads.length===0) list.innerHTML = `<div class="small muted" style="padding: 10px; text-align:center;">No chats yet.</div>`;

  myThreads.forEach(t=>{
    const partnerId = t.participants.find(id => id !== state.currentUserId);
    const partnerName = getUserDisplay(partnerId);
    const lastMsg = t.messages.slice(-1)[0];
    const el = document.createElement('div');
    el.className = 'card';
    el.style.padding = '10px';
    el.style.cursor = 'pointer';
    el.style.marginBottom = '6px';
    el.onclick = ()=> openThread(t.threadId);
    el.innerHTML = `
      <div style="font-weight:700">${partnerName}</div>
      <div class="small muted">${(lastMsg.from === state.currentUserId ? 'You: ' : '')}${sanitize(lastMsg.txt.slice(0,30))}...</div>
    `;
    list.appendChild(el);
  });
}

function openThread(threadId){
  if(!state.currentUserId) return notify('Please login to view threads', true);
  const t = state.dms.find(x=>x.threadId===threadId);
  if(!t) return;
  const partnerId = t.participants.find(id => id !== state.currentUserId);
  const partnerName = getUserDisplay(partnerId);
  document.querySelector('#dmModal .modal-header strong').innerText = `Chat with ${partnerName}`;

  const root = document.getElementById('dmThread');
  root.innerHTML = t.messages.map(m=>
    `<div style="padding:8px; background: ${m.from === state.currentUserId ? 'rgba(255, 140, 0, 0.2)' : 'rgba(255, 215, 0, 0.2)'}; border-radius: 10px; margin-bottom: 6px; margin-left: ${m.from === state.currentUserId ? 'auto' : '0'}; width: fit-content; max-width: 90%;">
      <strong>${getUserDisplay(m.from)}</strong>: ${sanitize(m.txt)} 
      <div class="u-xxs muted" style="margin-top: 2px;">${timeAgo(m.at)}</div>
    </div>`
  ).join('');
  root.scrollTop = root.scrollHeight;
  
  document.getElementById('dmSend').onclick = ()=> {
    const txt = document.getElementById('dmInput').value.trim();
    if(!txt) return;
    t.messages.push({from: state.currentUserId, txt, at: nowISO()});
    save();
    renderDMList();
    openThread(threadId);
    document.getElementById('dmInput').value='';
    notify('Message sent');
  };
}

document.getElementById('startDmBtn').onclick = ()=> {
  if(!state.currentUserId) return notify('Login to start a DM', true);
  const recipientName = prompt('Enter username to start a chat with:');
  const recipient = state.users.find(u => u.username === recipientName);
  if(!recipient) return notify('User not found.', true);
  if(recipient.id === state.currentUserId) return notify('Cannot chat with yourself.', true);

  // Check if thread already exists
  let thread = state.dms.find(t => 
    t.participants.includes(state.currentUserId) && t.participants.includes(recipient.id)
  );

  if(!thread) {
    // Create new thread
    thread = {
      threadId: uid('dm'),
      participants: [state.currentUserId, recipient.id],
      messages: [{from: state.currentUserId, txt: 'Hi, wanna roast something?', at: nowISO()}]
    };
    state.dms.push(thread);
    save();
  }
  
  renderDMList();
  openThread(thread.threadId);
  notify(`Started chat with ${recipient.displayName}`);
};

/* ------------------------- Explore Modal ------------------------- */
document.getElementById('openExplore').onclick = openExploreModal;
document.getElementById('mobileOpenExplore').onclick = openExploreModal;

function openExploreModal(){
  // Create and append modal content dynamically
  const modal = document.createElement('div');
  modal.className = 'modal-overlay show';
  modal.id = 'exploreModal';
  modal.setAttribute('role','dialog');

  const postTemplatesHtml = `
  <h3 style="font-size:18px; color: var(--accent); margin-top:20px;">Roast Templates</h3>
  <div style="margin-top:12px;display:grid;grid-template-columns:1fr;gap:10px">
    <div class="template" data-t="I'm about to drop a roast on {Topic} and need a partner. Who's in?">The Setup Roast (Partner Needed)</div>
    <div class="template" data-t="Unpopular Roast: {Target} is secretly good at {Skill} but nobody noticed.">Hidden Talent Roast</div>
    <div class="template" data-t="The truth is, {Person} is trying too hard to be {Adjective}.">Trying Too Hard Truth</div>
    <div class="template" data-t="Challenge: Roast [A] using only compliments.">The Compliment Roast</div>
    <div class="template" data-t="If my parents saw my bank balance they'd...">Money truth format</div>
  </div>
  `;

  modal.innerHTML = `
    <div class="modal">
      <div class="modal-header">
        <strong>🔍 Explore & Discover</strong>
        <button class="ghost" id="closeExplore">✖</button>
      </div>
      <h3 style="font-size:18px; margin-top:0; color: var(--accent);">Trending Tags</h3>
      <div style="display:flex;flex-wrap:wrap;gap:10px; margin-bottom:20px" id="exploreTags">
        <div class="tag" data-tag="Parents">#Parents</div>
        <div class="tag" data-tag="SchoolLife">#SchoolLife</div>
        <div class="tag" data-tag="KotaTruths">#KotaTruths</div>
        <div class="tag" data-tag="Dating">#Dating</div>
        <div class="tag" data-tag="Bollywood">#Bollywood</div>
      </div>
      ${postTemplatesHtml}
      <h3 style="font-size:18px; color: var(--accent);">Top Posts (Grid View)</h3>
      <div style="font-size:12px; margin-bottom: 15px;" class="muted">Click to share / view full post</div>
      <div id="exploreGridContent" class="explore-grid">
        ${state.posts.slice(0,40).map(p=>`<div class="explore-item" data-id="${p.id}">${sanitize(p.content.slice(0,40))}...</div>`).join('')}
      </div>
      <h3 style="font-size:18px; margin-top: 25px; color: var(--accent);">Top Users (Leaderboard)</h3>
      <div id="exploreLeaderboard"></div>
    </div>
  `;

  document.body.appendChild(modal);

  const lbBox = modal.querySelector('#exploreLeaderboard');
  const sorted = state.users.slice().sort((a,b)=> (b.xp||0)-(a.xp||0));
  sorted.slice(0,8).forEach((u, i)=>{
    const row = document.createElement('div');
    row.className = 'leaderboard-row';
    const rank = i+1;
    row.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><div class="avatar" style="width:30px;height:30px;font-size:14px; background: none; border-radius: 50%; border: 1px solid var(--accent);">${rank}</div><div>${sanitize(u.displayName)}</div></div><div class="small">XP: ${u.xp||0}</div>`;
    lbBox.appendChild(row);
  });
  
  modal.querySelector('#closeExplore').onclick = ()=> {
    document.body.removeChild(modal);
  };

  modal.querySelectorAll('.explore-item').forEach(it=> it.onclick = ()=> {
    const id = it.getAttribute('data-id');
    const p = state.posts.find(x=>x.id===id);
    if(p){ sharePost(id); notify(`Post content: "${p.content}"`); }
  });

  modal.querySelectorAll('.template').forEach(t=> t.onclick = (e)=>{
    const text = e.target.getAttribute('data-t');
    document.getElementById('postContent').value = text;
    document.body.removeChild(modal);
    window.scrollTo({top:0,behavior:'smooth'});
    document.getElementById('postContent').focus();
    notify('Template loaded to composer');
  });

  modal.querySelectorAll('.tag').forEach(t=> t.onclick = (e)=>{
    document.getElementById('topicSelect').value = e.target.getAttribute('data-tag');
    document.body.removeChild(modal);
    renderFeed();
    notify(`Filtering by ${e.target.innerText}`);
  });
}


/* ------------------------- Data Tools ------------------------- */
function exportData(){
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `roastabit_data_backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  notify('Data exported!');
}

function wipeAll(){
  if(confirm('DANGER: This will wipe ALL your local posts, users, DMs, and everything. Are you sure?')){
    localStorage.removeItem(DBKEY);
    state = { users: [], posts: [], stories: [], dms: [], notifications: [], currentUserId: null, bookmarks: [], reports: [] };
    load(); // Reload initial empty state
    seedIfEmpty(); // Re-seed initial demo data
    renderAll();
    notify('All local data wiped!', true);
    document.getElementById('profileModal').classList.remove('show');
  }
}

document.getElementById('exportBtn').onclick = exportData;
document.getElementById('wipeBtn').onclick = wipeAll;
document.getElementById('demoFill').onclick = ()=>{
  // simple demo function: clear all posts and refill with seed data posts only.
  load(); 
  state.posts = []; 
  seedIfEmpty(); // This will re-seed everything but we only care about posts
  state.posts = state.posts.slice(0, 3); // Keep only the initial 3 posts
  save(); 
  renderAll(); 
  notify('Demo loaded');
};


/* -------------------------
   Misc UI wiring
   ------------------------- */
document.getElementById('floatingPost').onclick = ()=> { window.scrollTo({top:0,behavior:'smooth'}); document.getElementById('postContent').focus(); };
document.getElementById('clearBtn').onclick = ()=>{ document.getElementById('searchInput').value=''; document.getElementById('topicSelect').value=''; renderFeed(); };
document.getElementById('searchInput').oninput = ()=> renderFeed();
document.getElementById('sortSelect').onchange = ()=> renderFeed();
document.getElementById('topicSelect').onchange = ()=> renderFeed();

/* -------------------------
   Initial render
   ------------------------- */
function renderAll(){
  load(); seedIfEmpty();
  renderUserArea();
  renderFeed();
  renderStories();
  renderLeaderboard();
  renderNotifCount();
}
load(); seedIfEmpty(); renderAll();

/* -------------------------
   PWA service worker registration stub
   ------------------------- */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/sw.js').then(()=>console.log('sw registered (stub)')).catch(()=>{/* ignore */});
}
</script>
</body>
</html>
